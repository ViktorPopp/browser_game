<!DOCTYPE html>
<html>
  <head>
    <title>Multiplayer Platformer</title>
    <style>
      canvas {
        background: #eef;
        display: block;
        margin: 0 auto;
      }
    </style>
  </head>
  <body>
    <canvas id="game" width="800" height="400"></canvas>
    <script>
      const canvas = document.getElementById("game");
      const ctx = canvas.getContext("2d");
      const socket = new WebSocket("ws://localhost:8080");

      let localPlayerId = null;
      const players = {};

      const keys = { left: false, right: false, up: false };

      document.addEventListener("keydown", (e) => {
        if (e.code === "ArrowLeft") keys.left = true;
        if (e.code === "ArrowRight") keys.right = true;
        if (e.code === "ArrowUp") keys.up = true;
      });
      document.addEventListener("keyup", (e) => {
        if (e.code === "ArrowLeft") keys.left = false;
        if (e.code === "ArrowRight") keys.right = false;
        if (e.code === "ArrowUp") keys.up = false;
      });

      let playerName = null;

      function promptName() {
        playerName = prompt(
          "Enter your player name:",
          "Player" + Math.floor(Math.random() * 1000)
        );
        if (!playerName || playerName.trim() === "") {
          playerName = "Player" + Math.floor(Math.random() * 1000);
        }
      }

      socket.onopen = () => {
        promptName();
        socket.send(JSON.stringify({ type: "login", name: playerName }));
      };

      socket.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === "init") {
          localPlayerId = data.id;
          Object.assign(players, data.players);
        } else if (data.type === "join") {
          players[data.id] = { x: data.x, y: data.y, name: data.name };
        } else if (data.type === "move") {
          if (players[data.id]) {
            players[data.id].x = data.x;
            players[data.id].y = data.y;
          }
        } else if (data.type === "leave") {
          delete players[data.id];
        }
      };

      function update() {
        const player = players[localPlayerId];
        if (!player) return;

        if (!player.vx) player.vx = 0;
        if (!player.vy) player.vy = 0;
        if (!player.onGround) player.onGround = false;

        player.vx = 0;
        if (keys.left) player.vx = -3;
        if (keys.right) player.vx = 3;
        if (keys.up && player.onGround) {
          player.vy = -10;
          player.onGround = false;
        }

        player.vy += 0.5; // gravity
        player.x += player.vx;
        player.y += player.vy;

        // floor collision
        if (player.y >= 360) {
          player.y = 360;
          player.vy = 0;
          player.onGround = true;
        }

        socket.send(JSON.stringify({ type: "move", x: player.x, y: player.y }));
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        ctx.fillStyle = "#444";
        ctx.fillRect(0, 380, canvas.width, 20); // ground

        for (const id in players) {
          const p = players[id];
          ctx.fillStyle = id == localPlayerId ? "#00f" : "#f00";
          ctx.fillRect(p.x, p.y, 30, 30);

          // Draw name tag above player
          if (p.name) {
            ctx.fillStyle = "#000";
            ctx.font = "14px Arial";
            ctx.textAlign = "center";
            ctx.fillText(p.name, p.x + 15, p.y - 5);
          }
        }
      }

      function gameLoop() {
        update();
        draw();
        requestAnimationFrame(gameLoop);
      }

      gameLoop();
    </script>
  </body>
</html>
